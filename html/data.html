<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Th∆∞ vi·ªán PTIT</title>
    <link rel="icon" href="../img/logo_web_page_circle.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/data.css">
    <style>
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <ul>
                {% for table_name in data.keys() %}
                    <li onclick="showTable('{{ table_name }}')" id="btn-{{ table_name }}">{{ table_name }}</li>
                {% endfor %}
            </ul>
        </div>
        <div class="content">
            <div >
                <h1>LIBRARY MANAGEMENT SYSTEM</h1>
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm trong t·∫•t c·∫£ c√°c b·∫£ng...">
                    <button id="searchButton"><i class="fas fa-search"></i></button>
                </div>
                {% for table_name, content in data.items() %}
                    <div id="table-{{ table_name }}" class="table-wrapper">
                        <h2>B·∫£ng: {{ table_name }}</h2>
                        <div>
                            <button  class="add-new-btn" data-table="{{ table_name }}" data-columns="{{ content.columns|join(',') }}">‚ûï Th√™m m·ªõi</button>
                             <button class="toggle-edit-mode-btn" title="Ch·∫ø ƒë·ªô s·ª≠a">‚úèÔ∏è S·ª≠a</button> 
                            <button class="toggle-delete-mode-btn" title="Ch·∫ø ƒë·ªô x√≥a">üóëÔ∏è X√≥a</button>   
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    {% for col in content.columns %}
                                        <th>{{ col }}</th>
                                    {% endfor %}
                                    <th class="col-edit">H√†nh ƒë·ªông</th> 
                                    <th class="col-delete">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in content.rows %}
                                    <tr data-row-id="{{ row[0] }}">
                                        {% for cell in row %}
                                            <td data-column-name="{{ content.columns[loop.index0] }}">{{ cell }}</td>
                                        {% endfor %}
                                        <td class="col-edit">
                                            <button class="edit-row-btn" data-id="{{ row[0] }}" title="S·ª≠a h√†ng n√†y">
                                                ‚úèÔ∏è
                                            </button>
                                        </td>
                                        <td class="col-delete">
                                            <button class="delete-row-btn" data-id="{{ row[0] }}" title="X√≥a h√†ng n√†y">
                                                ‚ùå
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% endfor %}
            </div>
        </div>
        <div id="add-data-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Th√™m d·ªØ li·ªáu m·ªõi</h3>
                    <button type="button" class="btn-close-modal" title="ƒê√≥ng">√ó</button>
                </div>
                <div class="modal-body">
                    <form id="add-data-form">
                        <div id="modal-form-fields">
                            </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-cancel">H·ªßy</button>
                    <button type="submit" form="add-data-form" class="btn-save">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTable(tableName) {
            // L·∫•y ph·∫ßn t·ª≠ thanh t√¨m ki·∫øm
            const searchContainer = document.querySelector('.search-container');
            searchContainer.style.display = 'flex';
            // ·∫®n t·∫•t c·∫£ c√°c b·∫£ng
            document.querySelectorAll('.table-wrapper').forEach(el => {
                el.classList.remove('active');
            });

            // B·ªè class active kh·ªèi sidebar c≈©
            document.querySelectorAll('.sidebar li').forEach(li => {
                li.classList.remove('active');
            });

            // Hi·ªán b·∫£ng ƒë∆∞·ª£c ch·ªçn
            document.getElementById('table-' + tableName).classList.add('active');
            document.getElementById('btn-' + tableName).classList.add('active');
        }

        // M·∫∑c ƒë·ªãnh hi·ªÉn th·ªã b·∫£ng ƒë·∫ßu ti√™n
        window.onload = function() {
            const firstBtn = document.querySelector('.sidebar li');
            if (firstBtn) {
                firstBtn.click();
            }
        }
         function searchTables() {
            // L·∫•y t·ª´ kh√≥a t√¨m ki·∫øm v√† chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            // L·∫•y t·∫•t c·∫£ c√°c table-wrapper tr·ª´ c√°i c·ªßa CV
            const tableWrappers = document.querySelectorAll('.table-wrapper:not(#table-cv)');

            // L·∫∑p qua t·ª´ng b·∫£ng d·ªØ li·ªáu
            tableWrappers.forEach(wrapper => {
                const rows = wrapper.querySelectorAll('tbody tr');
                
                // L·∫∑p qua t·ª´ng h√†ng c·ªßa b·∫£ng
                rows.forEach(row => {
                    const rowText = row.textContent.toLowerCase();
                    
                    // N·∫øu n·ªôi dung h√†ng ch·ª©a t·ª´ kh√≥a t√¨m ki·∫øm, th√¨ hi·ªán n√≥ ra
                    // Ng∆∞·ª£c l·∫°i, ·∫©n n√≥ ƒëi
                    if (rowText.includes(searchTerm)) {
                        row.style.display = ''; // Hi·ªán h√†ng
                    } else {
                        row.style.display = 'none'; // ·∫®n h√†ng
                    }
                });
            });
        }

        // G·∫Øn s·ª± ki·ªán 'click' cho n√∫t t√¨m ki·∫øm
        document.getElementById('searchButton').addEventListener('click', searchTables);

        // G·∫Øn s·ª± ki·ªán 'keyup' ƒë·ªÉ khi nh·∫•n Enter c≈©ng th·ª±c hi·ªán t√¨m ki·∫øm
        document.getElementById('searchInput').addEventListener('keyup', function(event) {
            if (event.key === 'Enter') {
                searchTables();
            }
        });

    const modal = document.getElementById('add-data-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalFormFields = document.getElementById('modal-form-fields');
        const addDataForm = document.getElementById('add-data-form');
        let currentTable = '';

        // S·ª¨A ƒê·ªîI: H√†m m·ªü Modal ƒë·ªÉ x·ª≠ l√Ω c·∫£ Th√™m v√† S·ª≠a
        // D√°n v√† thay th·∫ø to√†n b·ªô h√†m openDataModal c≈© b·∫±ng h√†m n√†y
        function openDataModal(tableName, columns, rowData = null) {
            currentTable = tableName;
            modalFormFields.innerHTML = '';
            addDataForm.reset(); 

            if (rowData) {
                // Ch·∫ø ƒë·ªô S·ª≠a (Kh√¥ng thay ƒë·ªïi)
                modalTitle.textContent = 'S·ª≠a d·ªØ li·ªáu';
                addDataForm.dataset.mode = 'edit';
                addDataForm.dataset.rowId = rowData[columns[0]]; 

                columns.forEach(column => {
                    const isPrimaryKey = column === columns[0];
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';
                    const label = document.createElement('label');
                    label.setAttribute('for', column);
                    label.textContent = column;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = column;
                    input.name = column;

                    if (isPrimaryKey) {
                        input.readOnly = true;
                    }
                    
                    if (rowData[column] !== undefined) {
                        input.value = rowData[column];
                    }

                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                    modalFormFields.appendChild(formGroup);
                });

            } else {
                // Ch·∫ø ƒë·ªô Th√™m (ƒê√É ƒê∆Ø·ª¢C C·∫¨P NH·∫¨T)
                modalTitle.textContent = 'Th√™m d·ªØ li·ªáu m·ªõi';
                addDataForm.dataset.mode = 'add';
                addDataForm.dataset.rowId = '';

                // S·ª¨A ƒê·ªîI: Kh√¥ng b·ªè qua c·ªôt kh√≥a ch√≠nh n·ªØa
                // Gi·ªù ƒë√¢y form s·∫Ω hi·ªÉn th·ªã t·∫•t c·∫£ c√°c c·ªôt ƒë·ªÉ ng∆∞·ªùi d√πng nh·∫≠p li·ªáu
                columns.forEach(column => {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';
                    const label = document.createElement('label');
                    label.setAttribute('for', column);
                    label.textContent = column;
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = column;
                    input.name = column;
                    input.required = true;

                    formGroup.appendChild(label);
                    formGroup.appendChild(input);
                    modalFormFields.appendChild(formGroup);
                });
            }

            modal.style.display = 'flex';
        }

        function closeAddModal() {
            modal.style.display = 'none';
        }

        // S·ª± ki·ªán cho n√∫t "Th√™m m·ªõi"
        document.querySelectorAll('.add-new-btn').forEach(button => {
            button.addEventListener('click', function() {
                const tableName = this.dataset.table;
                const columns = this.dataset.columns.split(',');
                openDataModal(tableName, columns); // M·ªü modal ·ªü ch·∫ø ƒë·ªô th√™m m·ªõi
            });
        });

        // ƒê√≥ng modal
        modal.querySelector('.btn-cancel').addEventListener('click', closeAddModal);
        modal.querySelector('.btn-close-modal').addEventListener('click', closeAddModal);
        modal.addEventListener('click', function(event) {
            if (event.target === modal) closeAddModal();
        });

        // S·ª¨A ƒê·ªîI: X·ª≠ l√Ω submit form cho c·∫£ Th√™m v√† S·ª≠a
        addDataForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            const mode = this.dataset.mode;
            const rowId = this.dataset.rowId;
            const primaryKeyColumn = document.querySelector(`#table-${currentTable} th`).textContent;

            // Lo·∫°i b·ªè kh√≥a ch√≠nh kh·ªèi d·ªØ li·ªáu g·ª≠i ƒëi khi c·∫≠p nh·∫≠t
            if (mode === 'edit') {
                delete data[primaryKeyColumn];
            }

            const url = mode === 'add' ? `/add/${currentTable}`
                                     : `/update/${currentTable}/${primaryKeyColumn}/${rowId}`;
            const method = mode === 'add' ? 'POST' : 'PUT';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'C√≥ l·ªói x·∫£y ra');
                }

                const result = await response.json();
                alert(`Thao t√°c th√†nh c√¥ng!`);
                closeAddModal();
                // T·∫£i l·∫°i trang ƒë·ªÉ xem thay ƒë·ªïi, ho·∫∑c b·∫°n c√≥ th·ªÉ c·∫≠p nh·∫≠t h√†ng trong b·∫£ng b·∫±ng JS
                window.location.reload(); 

            } catch (error) {
                alert(`L·ªói: ${error.message}`);
            }
        });


        // TH√äM M·ªöI: X·ª≠ l√Ω b·∫≠t/t·∫Øt ch·∫ø ƒë·ªô s·ª≠a
        document.querySelectorAll('.toggle-edit-mode-btn').forEach(button => {
            button.addEventListener('click', function() {
                const tableWrapper = this.closest('.table-wrapper');
                const table = tableWrapper.querySelector('table');
                table.classList.toggle('edit-mode');
                this.classList.toggle('active');
            });
        });

    // ==== TH√äM D√íNG N√ÄY ƒê·ªÇ X·ª¨ L√ù N√öT ƒê√ìNG 'X' ·ªû HEADER ====
    modal.querySelector('.btn-close-modal').addEventListener('click', closeAddModal);

    // X·ª≠ l√Ω b·∫≠t/t·∫Øt ch·∫ø ƒë·ªô x√≥a
    document.querySelectorAll('.toggle-delete-mode-btn').forEach(button => {
        button.addEventListener('click', function() {
            // L·∫•y b·∫£ng t∆∞∆°ng ·ª©ng v·ªõi n√∫t ƒë∆∞·ª£c b·∫•m
            const tableWrapper = this.closest('.table-wrapper');
            const table = tableWrapper.querySelector('table');
            
            // B·∫≠t/t·∫Øt class 'delete-mode' v√† class 'active' c·ªßa n√∫t
            table.classList.toggle('delete-mode');
            this.classList.toggle('active');
        });
    });

    // X·ª≠ l√Ω khi b·∫•m n√∫t x√≥a tr√™n t·ª´ng h√†ng
    document.querySelectorAll('table tbody').forEach(tbody => {
            tbody.addEventListener('click', async function(event) {
                const target = event.target.closest('button');
                if (!target) return;

                const row = target.closest('tr');
                const tableWrapper = this.closest('.table-wrapper');
                const tableName = tableWrapper.id.replace('table-', '');
                const rowId = target.dataset.id;
                
                // X·ª≠ l√Ω n√∫t S·ª≠a
                if (target.classList.contains('edit-row-btn')) {
                    const headers = Array.from(tableWrapper.querySelectorAll('th')).map(th => th.textContent);
                    const cells = Array.from(row.querySelectorAll('td')).map(td => td.textContent);

                    const rowData = headers.reduce((obj, header, index) => {
                        // B·ªè qua c√°c c·ªôt h√†nh ƒë·ªông ·ªü cu·ªëi
                        if (header !== 'S·ª≠a' && header !== 'H√†nh ƒë·ªông') {
                           obj[header] = cells[index];
                        }
                        return obj;
                    }, {});

                    openDataModal(tableName, headers.filter(h => h !== 'S·ª≠a' && h !== 'H√†nh ƒë·ªông'), rowData);
                }

                // X·ª≠ l√Ω n√∫t X√≥a
                if (target.classList.contains('delete-row-btn')) {
                    const primaryKeyColumn = tableWrapper.querySelector('th').textContent;
                    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h√†ng c√≥ ID = ${rowId} kh√¥ng?`)) {
                        try {
                            const response = await fetch(`/delete/${tableName}/${primaryKeyColumn}/${rowId}`, {
                                method: 'DELETE'
                            });
                            if (!response.ok) {
                                const errorData = await response.json();
                                throw new Error(errorData.detail || 'Kh√¥ng th·ªÉ x√≥a d·ªØ li·ªáu.');
                            }
                            row.remove();
                            alert('ƒê√£ x√≥a th√†nh c√¥ng!');
                        } catch (error) {
                            alert(`L·ªói: ${error.message}`);
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
